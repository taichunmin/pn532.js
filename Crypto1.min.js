!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("lodash"),require("./main")):"function"==typeof define&&define.amd?define(["lodash","./main"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).Crypto1=e(t._,t.Pn532)}(this,(function(t,e){"use strict";const r=2739804,s=8849412,n=new DataView(new ArrayBuffer(4)),i=[401729,200864,100432,50216,25108,12554,548400,813485,406742,744670,911578,455789,736387,368193,690581,852607,426303,213151,648954],o=[978680576,1563082112,781541056,390770528,195385264,97692632,71949928,75785392,1111634520,662803112,358630096,179315048,1140366128,1643924888,1985916232,2106580256,2127031952,2137257800,2031185952],d=[324477,162238,621162,310581,155290,77645,38822,527718,802822,401411,743092,371546,693016,855865,427932,722299,361149,180574,90287,587490,802244,940119,470059,235029,626111,819306,919168,459584,229792,624229,312114,665388],a=[1015592976,1581538312,696427904,348213952,1247848800,623924400,1385704024,804036264,290899152,145449576,1123367600,561683800,371049768,229533968,1188508808,634065344,1390774496,1769129072,884564536,1560033944,685676232,315605216,1231544432,1689514040,1962505112,2094805576,953062048,476531024,238265512,28924368,1088204008,651091440],l=[542389,271194,135597],f=[27796192,564667104,564667104];class c{even=0;odd=0;constructor({even:e,odd:r}={}){t.isNil(e)||t.isNil(r)||([this.even,this.odd]=[e,r])}reset(){return[this.odd,this.even]=[0,0],this}setLfsr(t){if(!e.Packet.isLen(t,6))throw new TypeError("key must be 6 bytes");this.reset();for(let e=47;e>0;e-=2)[this.odd,this.even]=[this.odd<<1|t.getBit(e-1^7),this.even<<1|t.getBit(7^e)];return this}getLfsr(){const{bit:t}=c,r=new e.Packet(6);for(let e=23;e>=0;e--)r.setBit(46-2*e,t(this.odd,3^e),!0),r.setBit(47-2*e,t(this.even,3^e),!0);return r}lfsrBit(t,e){const{evenParity32:n,filter:i,toBool:o,toUint32:d}=c,a=i(this.odd),l=a&o(e)^o(t)^r&this.odd^s&this.even;return[this.odd,this.even]=[d(this.even<<1|n(l)),this.odd],a}lfsrByte(t,e){const{bit:r}=c;let s=0;for(let n=0;n<8;n++)s|=this.lfsrBit(r(t,n),e)<<n;return s}lfsrWord(t,e){const{beBit:r}=c,s=new Uint32Array([0]);for(let n=0;n<32;n++)s[0]|=this.lfsrBit(r(t,n),e)<<(24^n);return s[0]}lfsrRollbackBit(t,e){const{evenParity32:n,filter:i,toBit:o,toBool:d,toUint24:a,toUint32:l}=c;[this.even,this.odd]=[a(this.odd),this.even];const f=i(this.odd);let u=o(this.even);return u^=s&(this.even>>>=1),u^=r&this.odd,u^=d(t)^f&d(e),this.even=l(this.even|n(u)<<23),f}lfsrRollbackByte(t,e){const{bit:r}=c;let s=0;for(let n=7;n>=0;n--)s|=this.lfsrRollbackBit(r(t,n),e)<<n;return s}lfsrRollbackWord(t,e){const{beBit:r}=c,s=new Uint32Array(1);for(let n=31;n>=0;n--)s[0]|=this.lfsrRollbackBit(r(t,n),e)<<(24^n);return s[0]}static beBit(t,e){return c.bit(t,24^e)}static bit(t,e){return c.toBit(t>>>e)}static toBit(t){return 1&t}static toBool(t){return t?1:0}static toUint24(t){return 16777215&t}static toUint32(t){return t>>>0}static toUint8(t){return 255&t}static filter(t){let e=0;return e|=991936>>>(15&t)&16,e|=444864>>>(t>>>4&15)&8,e|=247984>>>(t>>>8&15)&4,e|=123992>>>(t>>>12&15)&2,e|=55608>>>(t>>>16&15)&1,c.bit(3965184010,e)}static evenParity8(t){return t^=t>>>4,t^=t>>>2,c.toBit(t^t>>>1)}static evenParity32(t){return t^=t>>>16,c.evenParity8(t^t>>>8)}static swapEndian(t){return n.setUint32(0,t,!1),n.getUint32(0,!0)}static prngSuccessor(t,e){const{swapEndian:r}=c;for(t=r(t);e--;)t=t>>>1|(t>>>16^t>>>18^t>>>19^t>>>21)<<31;return r(t)}static updateContribution(t,e,r){const{evenParity32:s,toUint32:n}=c;let i=t>>>25;return i=i<<1|s(t&e),i=i<<1|s(t&r),n(i<<24|16777215&t)}static extendTable(t,e,r,s,n,i){const{filter:o,toUint32:d,updateContribution:a}=c;i=d(i<<24);for(let d=0;d<e;d++){const l=o(t[d]*=2);l^o(1|t[d])?t[d]=a(t[d]+(l^r),s,n)^i:l===r?(t[e++]=t[++d],t[d]=a(t[d-1]+1,s,n)^i,t[d-1]=a(t[d-1],s,n)^i):t[d--]=t[--e]}return e}static extendTableSimple(t,e,r){const{filter:s}=c;for(let n=0;n<e;n++){const i=s(t[n]*=2);i^s(1|t[n])?t[n]+=i^r:i===r?(t[e++]=t[++n],t[n]=t[n-1]+1):t[n--]=t[--e]}return e}static recover(e){const{evenParity32:n,extendTable:i,recover:o,toBit:d,toBool:a,toUint32:l}=c,{evens:f,odds:u,states:h}=e;if(e.rem<0)for(let t=0;t<f.s;t++){f.d[t]=f.d[t]<<1^n(f.d[t]&s)^a(4&e.input);for(let e=0;e<u.s;e++)h.push(new c({even:u.d[e],odd:l(f.d[t]^n(u.d[e]&r))}))}else{for(let t=0;t<4&&e.rem--;t++){if([e.oks,e.eks,e.input]=[e.oks>>>1,e.eks>>>1,e.input>>>2],u.s=i(u.d,u.s,d(e.oks),17698825,5479608,0),!u.s)return;if(f.s=i(f.d,f.s,d(e.eks),r,17698825,3&e.input),!f.s)return}for(f.d.subarray(0,f.s).sort(),u.d.subarray(0,u.s).sort();u.s+f.s;){const[r,s]=t.map([u.d[u.s-1],f.d[f.s-1]],(t=>l(4278190080&t)));if(r===s){const[n,i]=[t.sortedIndex(f.d.subarray(0,f.s),r),t.sortedIndex(u.d.subarray(0,u.s),s)];o({...e,evens:{d:new Uint32Array(f.d.buffer,f.d.byteOffset+4*n),s:f.s-n},odds:{d:new Uint32Array(u.d.buffer,u.d.byteOffset+4*i),s:u.s-i}}),[f.s,u.s]=[n,i]}else r>s?u.s=t.sortedIndex(u.d.subarray(0,u.s),r):f.s=t.sortedIndex(f.d.subarray(0,f.s),s)}}}static lfsrRecovery32(t,e){const{beBit:r,extendTableSimple:s,filter:n,recover:i,swapEndian:o,toBit:d,toUint32:a}=c,l={s:0,d:new Uint32Array(1<<21)},f={s:0,d:new Uint32Array(1<<21)},u=[];let[h,y]=[0,0];for(let e=31;e>0;e-=2)h=a(h<<1|r(t,e)),y=a(y<<1|r(t,e-1));for(let[t,e,r]=[1<<20,d(y),d(h)];t>=0;t--)n(t)===r&&(f.d[f.s++]=t),n(t)===e&&(l.d[l.s++]=t);for(let t=0;t<4;t++)[y,h]=[y>>>1,h>>>1],l.s=s(l.d,l.s,d(y)),f.s=s(f.d,f.s,d(h));return i({eks:y,evens:l,odds:f,oks:h,states:u,rem:11,input:(e=o(e))<<1}),u}static lfsrRecovery64(t,e){const{beBit:n,evenParity32:u,extendTableSimple:h,filter:y}=c,v=new Uint8Array(32),w=new Uint8Array(32),b=new Uint8Array(32);let[p,g]=[0,0];const k={d:new Uint32Array(65536),s:0};for(let r=30;r>=0;r-=2)v[r>>>1]=n(t,r),v[16+(r>>>1)]=n(e,r);for(let r=31;r>=0;r-=2)w[r>>>1]=n(t,r),w[16+(r>>>1)]=n(e,r);for(let t=1048575;t>=0;t--)if(y(t)===v[0]){k.s=0,k.d[k.s++]=t;for(let t=1;k.s&&t<29;t++)k.s=h(k.d,k.s,v[t]);if(k.s){for(let e=0;e<19;e++)p=p<<1|u(t&i[e]);for(let e=0;e<32;e++)b[e]=u(t&d[e]);for(let e=k.s-1;e>=0;e--)try{for(let r=0;r<3;r++)if(k.d[e]<<=1,k.d[e]|=u(t&l[r]^k.d[e]&f[r]),y(k.d[e])!==v[29+r])throw new Error("cont2");for(let t=0;t<19;t++)g=g<<1|u(k.d[e]&o[t]);g^=p;for(let t=0;t<32;t++)if(g=g<<1^b[t]^u(k.d[e]&a[t]),y(g)!==w[t])throw new Error("cont2");return k.d[e]=k.d[e]<<1|u(s&k.d[e]),new c({even:g,odd:k.d[e]^u(r&g)})}catch(t){if("cont2"!==t.message)throw t}}}}static mfkey32v2(r){for(const s of["uid","nt0","nr0","ar0","nt1","nr1","ar1"]){if(e.Packet.isLen(r[s])){if(r[s].length<4)throw new TypeError(`invalid args.${s}.length`);r[s]=r[s].getUint32(0,!1)}if(t.isString(r[s])&&(r[s]=t.parseInt(r[s],16)),!t.isSafeInteger(r[s]))throw new TypeError(`invalid args.${s}`)}const{ar0:s,ar1:n,nr0:i,nr1:o,nt0:d,nt1:a,uid:l}=r,{lfsrRecovery32:f,prngSuccessor:u,toUint32:h}=c,y=u(d,64),v=u(a,64),w=f(s^y,0);for(const t of w){t.lfsrRollbackWord(0,!1),t.lfsrRollbackWord(i,!0),t.lfsrRollbackWord(l^d,!1);const e=t.getLfsr();if(t.lfsrWord(l^a,!1),t.lfsrWord(o,!0),h(t.lfsrWord(0,!1)^v)===n)return e}throw new Error("failed to recover key")}static mfkey64(r){for(const s of["uid","nt","nr","ar","at"]){if(e.Packet.isLen(r[s])){if(r[s].length<4)throw new TypeError(`invalid args.${s}.length`);r[s]=r[s].getUint32(0,!1)}if(t.isString(r[s])&&(r[s]=t.parseInt(r[s],16)),!t.isSafeInteger(r[s]))throw new TypeError(`invalid args.${s}`)}const{ar:s,at:n,nr:i,nt:o,uid:d}=r,{lfsrRecovery64:a,prngSuccessor:l}=c,f=l(o,64),[u,h]=[s^f,n^l(f,32)],y=a(u,h);if(!y)throw new Error("failed to recover key");return y.lfsrRollbackWord(0,!1),y.lfsrRollbackWord(0,!1),y.lfsrRollbackWord(i,!0),y.lfsrRollbackWord(d^o,!1),y.getLfsr()}static decrypt(r){if(!e.Packet.isLen(r.key,6))throw new TypeError("invalid args.key");if(!e.Packet.isLen(r.data))throw new TypeError("invalid args.data");for(const s of["uid","nt","nr"]){if(e.Packet.isLen(r[s])){if(r[s].length<4)throw new TypeError(`invalid args.${s}.length`);r[s]=r[s].getUint32(0,!1)}if(t.isString(r[s])&&(r[s]=t.parseInt(r[s],16)),!t.isSafeInteger(r[s]))throw new TypeError(`invalid args.${s}`)}r.data=r.data.slice();const{data:s,key:n,nr:i,nt:o,uid:d}=r,a=new c;a.setLfsr(n),a.lfsrWord(d^o,!1),a.lfsrWord(i,!0);for(let t=0;t<2;t++)a.lfsrWord(0,!1);for(let t=0;t<s.length;t++)s[t]^=a.lfsrByte();return s}}return c}));
